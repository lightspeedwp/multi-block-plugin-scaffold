name: Release Management

# Automated version bumping and changelog generation

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
      prerelease_id:
        description: 'Prerelease identifier (e.g., beta, rc)'
        required: false
        type: string
        default: ''
      create_release:
        description: 'Create GitHub release after bump'
        required: false
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: write

jobs:
  version-bump:
    name: Bump Version
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.new_version }}
      old_version: ${{ steps.bump.outputs.old_version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "üìå Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: bump
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          TYPE="${{ inputs.version_type }}"
          PREID="${{ inputs.prerelease_id }}"

          # Parse current version
          IFS='.-' read -r MAJOR MINOR PATCH PREREL <<< "$CURRENT"

          case "$TYPE" in
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
              ;;
            patch)
              NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
              ;;
            prerelease)
              if [ -n "$PREID" ]; then
                if [ -n "$PREREL" ]; then
                  # Increment prerelease number
                  PREREL_NUM=$(echo "$PREREL" | grep -oE '[0-9]+$' || echo "0")
                  NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}-${PREID}.$((PREREL_NUM + 1))"
                else
                  NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))-${PREID}.1"
                fi
              else
                echo "‚ùå Prerelease identifier required for prerelease bumps"
                exit 1
              fi
              ;;
          esac

          echo "old_version=$CURRENT" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version bump: $CURRENT ‚Üí $NEW_VERSION"

      - name: Update version in files
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"

          # Update version using the update-version script
          node bin/update-version.js "$NEW_VERSION"

          echo "‚úÖ Updated version to $NEW_VERSION"

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit version bump
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"

          git add -A
          git commit -m "chore: bump version to $NEW_VERSION"
          git push

      - name: Create version tag
        run: |
          NEW_VERSION="${{ steps.bump.outputs.new_version }}"

          git tag "v$NEW_VERSION"
          git push origin "v$NEW_VERSION"

          echo "üè∑Ô∏è Created tag: v$NEW_VERSION"

  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    needs: version-bump
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Generate changelog
        id: changelog
        run: |
          NEW_VERSION="${{ needs.version-bump.outputs.new_version }}"
          OLD_VERSION="${{ needs.version-bump.outputs.old_version }}"

          echo "üìù Generating changelog for $OLD_VERSION ‚Üí $NEW_VERSION"

          # Get commits since last version
          if git rev-parse "v$OLD_VERSION" >/dev/null 2>&1; then
            COMMITS=$(git log "v$OLD_VERSION"..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges -20)
          fi

          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -iE "^- (feat|feature|add)" || true)
          FIXES=$(echo "$COMMITS" | grep -iE "^- (fix|bug|patch)" || true)
          DOCS=$(echo "$COMMITS" | grep -iE "^- (doc|docs)" || true)
          CHORES=$(echo "$COMMITS" | grep -iE "^- (chore|refactor|style|test|ci)" || true)
          OTHER=$(echo "$COMMITS" | grep -viE "^- (feat|feature|add|fix|bug|patch|doc|docs|chore|refactor|style|test|ci)" || true)

          # Build changelog
          CHANGELOG="## [$NEW_VERSION] - $(date +%Y-%m-%d)"
          CHANGELOG+="\n"

          if [ -n "$FEATURES" ]; then
            CHANGELOG+="\n### ‚ú® Features\n$FEATURES\n"
          fi

          if [ -n "$FIXES" ]; then
            CHANGELOG+="\n### üêõ Bug Fixes\n$FIXES\n"
          fi

          if [ -n "$DOCS" ]; then
            CHANGELOG+="\n### üìö Documentation\n$DOCS\n"
          fi

          if [ -n "$CHORES" ]; then
            CHANGELOG+="\n### üîß Maintenance\n$CHORES\n"
          fi

          if [ -n "$OTHER" ]; then
            CHANGELOG+="\n### üì¶ Other\n$OTHER\n"
          fi

          # Save to output (escape for JSON)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo -e "$CHANGELOG"

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [version-bump, generate-changelog]
    if: ${{ inputs.create_release }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.version-bump.outputs.new_version }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          tools: composer

      - name: Install dependencies
        run: |
          npm ci
          composer install --no-dev --optimize-autoloader

      - name: Build plugin
        run: npm run build

      - name: Create plugin ZIP
        run: npm run plugin-zip

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.version-bump.outputs.new_version }}
          name: v${{ needs.version-bump.outputs.new_version }}
          body: ${{ needs.generate-changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ contains(needs.version-bump.outputs.new_version, '-') }}
          files: |
            *.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-changelog-file:
    name: Update CHANGELOG.md
    runs-on: ubuntu-latest
    needs: [version-bump, generate-changelog]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update CHANGELOG.md
        run: |
          CHANGELOG="${{ needs.generate-changelog.outputs.changelog }}"

          if [ -f "CHANGELOG.md" ]; then
            # Insert new changelog entry after the header
            TEMP_FILE=$(mktemp)

            # Read first line (assumed to be # Changelog)
            head -n 2 CHANGELOG.md > "$TEMP_FILE"
            echo "" >> "$TEMP_FILE"
            echo -e "$CHANGELOG" >> "$TEMP_FILE"
            echo "" >> "$TEMP_FILE"
            tail -n +3 CHANGELOG.md >> "$TEMP_FILE"

            mv "$TEMP_FILE" CHANGELOG.md
          else
            # Create new CHANGELOG.md
            echo "# Changelog" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "All notable changes to this project will be documented in this file." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo -e "$CHANGELOG" >> CHANGELOG.md
          fi

          echo "‚úÖ Updated CHANGELOG.md"

      - name: Commit changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG.md for v${{ needs.version-bump.outputs.new_version }}" || true
          git push || true
