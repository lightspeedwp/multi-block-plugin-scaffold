#!/usr/bin/env sh

# Pre-commit hook for {{slug}} plugin
# This hook runs before each commit to ensure code quality

. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks for {{name}}..."

# Check if this is a scaffold template (has mustache variables)
if grep -q "{{slug}}" package.json 2>/dev/null; then
    echo "ğŸ“‹ Scaffold template detected - running safe dry-run checks..."
    npm run dry-run:all || {
        echo "âŒ Dry-run checks failed. Please fix the issues and try again."
        exit 1
    }
else
    echo "ğŸš€ Generated plugin detected - running lint-staged..."
    npx lint-staged
fi

# Run PHP linting (if composer is available and not in scaffold mode)
if command -v composer &> /dev/null; then
    if ! grep -q "{{slug}}" package.json 2>/dev/null; then
        echo "ğŸŸ¡ Linting PHP..."
        composer run lint || {
            echo "âŒ PHP linting failed. Please fix the issues and try again."
            exit 1
        }
    else
        echo "âš ï¸  Skipping PHP linting (scaffold template mode)"
    fi
else
    echo "âš ï¸  Skipping PHP linting (Composer not available)"
fi

# Run package.json validation
echo "ğŸŸ¡ Validating package.json..."
npm run lint:pkg-json || {
    echo "âŒ package.json validation failed. Please fix the issues and try again."
    exit 1
}

# Run security audit
echo "ğŸ”’ Running security audit..."
npm audit --audit-level=high --production || {
    echo "âš ï¸  Security vulnerabilities detected (high or critical)."
    echo "Run 'npm audit' for details or 'npm audit fix' to attempt automatic fixes."
    echo "To bypass this check (not recommended), use: git commit --no-verify"
    exit 1
}

echo "âœ… All pre-commit checks passed!"
